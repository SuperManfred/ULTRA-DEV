#!/bin/bash
#
# orchestrate - Run an orchestrator for a GitHub issue
#
# Usage: orchestrate <issue-number>
#
# This:
# 1. Creates a worktree for the issue
# 2. Writes CLAUDE.local.md with orchestrator context
# 3. Opens a new Terminal window with interactive `c` session
#
# The orchestrator can then approve commands and interact with you.
#
# Works from any git repository - uses current working directory to detect repo.
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ULTRA_DEV_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Detect repo from current working directory
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)" || {
    echo "Error: Not in a git repository"
    exit 1
}
REPO_NAME="$(basename "$REPO_ROOT")"

if [ -z "$1" ]; then
    echo "Usage: orchestrate <issue-number>"
    echo ""
    echo "Example: orchestrate 9"
    echo ""
    echo "Run from any git repo directory. Current repo: $REPO_NAME"
    exit 1
fi

ISSUE_NUMBER="$1"
# Use parent directory of REPO_ROOT, normalize to avoid .. in path
PARENT_DIR="$(cd "$REPO_ROOT/.." && pwd)"
WORKTREE_PATH="$PARENT_DIR/$REPO_NAME-wt-$ISSUE_NUMBER"

# Check if issue exists
if ! gh issue view "$ISSUE_NUMBER" &>/dev/null; then
    echo "Error: Issue #$ISSUE_NUMBER not found or not accessible"
    exit 1
fi

# Check if worktree already exists
if [ -d "$WORKTREE_PATH" ]; then
    echo "Worktree already exists at: $WORKTREE_PATH"
    echo "Opening terminal for existing worktree..."
else
    echo "Creating worktree for issue #$ISSUE_NUMBER..."

    # Create worktree
    cd "$REPO_ROOT"
    git worktree add "$WORKTREE_PATH" -b "feature/$ISSUE_NUMBER" 2>/dev/null || \
        git worktree add "$WORKTREE_PATH" "feature/$ISSUE_NUMBER"

    # Create context directories
    mkdir -p "$WORKTREE_PATH/.claude/outputs"
    mkdir -p "$WORKTREE_PATH/.claude/reviews"
    mkdir -p "$WORKTREE_PATH/.claude/dialog"
    mkdir -p "$WORKTREE_PATH/.claude/iterations"

    # Fetch issue from GitHub (body + comments)
    echo "Fetching issue #$ISSUE_NUMBER from GitHub..."
    gh issue view "$ISSUE_NUMBER" --json title,body,comments --jq '
        "# " + .title + "\n\n" + .body +
        if (.comments | length) > 0 then
            "\n\n---\n\n## Issue Comments\n\n" +
            ([.comments[] | "### Comment by " + .author.login + " (" + .createdAt[0:10] + ")\n\n" + .body] | join("\n\n---\n\n"))
        else
            ""
        end
    ' > "$WORKTREE_PATH/.claude/issue.md"
fi

# Determine prompts directory - use repo's prompts if they exist, otherwise fall back to ULTRA-DEV
if [ -f "$REPO_ROOT/prompts/orchestrator.md" ]; then
    PROMPTS_DIR="$REPO_ROOT/prompts"
else
    PROMPTS_DIR="$ULTRA_DEV_ROOT/prompts"
    echo "Note: Using ULTRA-DEV prompts (no prompts/ found in $REPO_NAME)"
fi

# Read orchestrator prompt and substitute issue number
ORCHESTRATOR_PROMPT=$(cat "$PROMPTS_DIR/orchestrator.md" | sed "s/ISSUE_NUMBER/$ISSUE_NUMBER/g")

# Write CLAUDE.local.md - Claude will read this automatically
cat > "$WORKTREE_PATH/CLAUDE.local.md" << CLAUDEEOF
# Orchestrator Context for Issue #$ISSUE_NUMBER

You are an orchestrator for this issue in the **$REPO_NAME** repository.

## Quick Reference

1. The issue is in: .claude/issue.md
2. Spawn implementer with: \`claude -p "\$(cat $PROMPTS_DIR/implementer.md)..."\`
3. Spawn reviewers with: \`claude -p\` and \`codex exec\`
4. Track dialog in: .claude/dialog/
5. **DO NOT COMMIT** - produce artifacts and report only

## Issue

$(cat "$WORKTREE_PATH/.claude/issue.md")

---

$ORCHESTRATOR_PROMPT

---

**IMPORTANT:** Do NOT commit any changes. Produce artifacts and report results only.
The user will review and decide whether to commit.
CLAUDEEOF

echo ""
echo "Worktree ready at: $WORKTREE_PATH"
echo "Repository: $REPO_NAME"
echo "CLAUDE.local.md written with orchestrator context"
echo ""
echo "Opening new Terminal window..."

# Open new Terminal window with interactive claude session
# ORCHESTRATOR_MODE enables hooks that constrain the orchestrator
osascript << EOF
tell application "Terminal"
    activate
    do script "cd '$WORKTREE_PATH' && export WORKTREE_ROOT='$WORKTREE_PATH' && export ORCHESTRATOR_MODE=true && echo 'Orchestrator for Issue #$ISSUE_NUMBER ($REPO_NAME)' && echo 'Worktree: $WORKTREE_PATH' && echo 'Mode: CONSTRAINED (hooks active)' && echo '' && c"
end tell
EOF

echo "Done. Terminal window opened with interactive Claude session."
